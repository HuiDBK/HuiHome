#!/usr/bin/python3
# -*- coding: utf-8 -*-
# @Author: Hui
# @Desc: { Redis 工具模块 }
# @Date: 2022/04/17 0:13
from datetime import timedelta

import aioredis
from loguru import logger

from house_rental.commons import settings
from house_rental.constants import constants
from house_rental.constants.enums import RedisDataType


class RedisCacheInfo(object):
    """ 统一缓存信息类 """

    def __init__(self, key, timeout=60, data_type=RedisDataType.STRING.value):
        """
        缓存信息类初始化
        :param key: 缓存的key
        :param timeout: 缓存过期时间, 单位秒
        :param data_type: 缓存采用的数据结构 (不传并不影响，用于标记业务采用的是什么数据结构)
        """
        self.key = key
        self.timeout = timeout
        self.data_type = data_type

    def __str__(self):
        _timeout = timedelta(seconds=self.timeout)
        return f"set cache key {self.key} timeout {_timeout} type {self.data_type}"


class RedisKey(object):
    """ Redis Key 统一管理"""

    @classmethod
    def mobile_sms_code(cls, mobile) -> RedisCacheInfo:
        """
        获取手机验证码 Redis key
        :param mobile: 手机号
        :return:
        """
        sms_code_cache_info = RedisCacheInfo(
            key=f'{constants.APP_NAME}:user:sms_code:{mobile}',
            timeout=constants.SMS_CODE_TIMEOUT,
            data_type=RedisDataType.STRING.value
        )
        return sms_code_cache_info

    @classmethod
    def user_house_collect(cls, user_id) -> RedisCacheInfo:
        """
        获取用户房源收藏 Redis key
        :param user_id: 用户id
        :return:
        """
        house_collect_cache_info = RedisCacheInfo(
            key=f'{constants.APP_NAME}:house:collect:user:{user_id}',
            timeout=constants.USER_HOUSE_COLLECT_TIMEOUT,
            data_type=RedisDataType.SET.value
        )
        return house_collect_cache_info

    @classmethod
    def house_detail(cls, house_id) -> RedisCacheInfo:
        """
        获取房源详情 Redis key
        :param house_id: 房源id
        :return:
        """
        house_detail_cache_info = RedisCacheInfo(
            key=f'{constants.APP_NAME}:house:detail:{house_id}',
            timeout=constants.HOUSE_DETAIL_TIMEOUT,
            data_type=RedisDataType.STRING.value
        )
        return house_detail_cache_info

    @classmethod
    def house_facilities(cls) -> RedisCacheInfo:
        """
        获取全部的房源设施 Redis key
        :return:
        """
        house_facilities_cache_info = RedisCacheInfo(
            key=f'{constants.APP_NAME}:house:facilities',
            timeout=constants.HOUSE_FACILITIES_TIMEOUT,
            data_type=RedisDataType.STRING.value
        )
        return house_facilities_cache_info

    @classmethod
    def areas(cls) -> RedisCacheInfo:
        """
        获取全部的省市区 Redis key
        :return:
        """
        house_facilities_cache_info = RedisCacheInfo(
            key=f'{constants.APP_NAME}:common:areas',
            timeout=constants.COMMON_AREAS_TIMEOUT,
            data_type=RedisDataType.STRING.value
        )
        return house_facilities_cache_info

    @classmethod
    def home_houses(cls, city) -> RedisCacheInfo:
        """
        首页房源缓存 Redis key
        :param city 所在城市
        :return:
        """
        house_facilities_cache_info = RedisCacheInfo(
            key=f'{constants.APP_NAME}:house:home_houses:{city}',
            timeout=constants.HOME_HOUSES_TIMEOUT,
            data_type=RedisDataType.STRING.value
        )
        return house_facilities_cache_info


from house_rental.commons.utils.decorators import singleton


@singleton
class RedisUtil(object):
    """ Redis 工具类"""

    def __init__(self, redis_client: aioredis.Redis = None):
        """
        Redis 工具类初始化
        :param redis_client: redis客户端
        """
        self.default_conn = 'default'  # 默认连接名
        self.redis_client = redis_client

    async def init_redis_pool(self, redis_conf: dict):
        """
        初始化redis连接池
        :param redis_conf: redis配置
        """
        for conn_name, conf in redis_conf.items():
            redis_pool = await self._create_redis_pool(**conf)
            self.__setattr__(conn_name, redis_pool)
        if not self.redis_client:
            self.redis_client = await self.get_redis_conn()

    async def _create_redis_pool(self, host, port, db, password, **kwargs) -> aioredis.Redis:
        """ 创建redis连接池【显式传参】 """
        minsize = kwargs.get('minsize') or 1
        maxsize = kwargs.get('maxsize') or 5
        timeout = kwargs.get('timeout') or 3

        redis_pool = await aioredis.create_redis_pool(
            f"redis://:{password}@{host}:{port}/{db}?encoding=utf-8",
            minsize=minsize,
            maxsize=maxsize,
            timeout=timeout
        )
        return redis_pool

    async def get_redis_conn(self, conn_name=None) -> aioredis.Redis:
        """
        获取redis连接
        :param conn_name: 连接名, 不传获取默认连接
        :return: redis_pool
        """
        conn_name = conn_name or self.default_conn
        redis_setting = settings.REDIS_CONFIG.get(conn_name)
        if not redis_setting:
            return
        if hasattr(self, conn_name):
            return self.__getattribute__(conn_name)

        redis_pool = await self._create_redis_pool(**redis_setting)
        self.__setattr__(conn_name, redis_pool)
        return redis_pool

    async def set_with_cache_info(self, redis_cache_info: RedisCacheInfo, value):
        """
        根据 RedisCacheInfo 设置 Redis 缓存
        :param redis_cache_info: RedisCacheInfo缓存信息对象
        :param value: 缓存的值
        :return:
        """
        logger.info(redis_cache_info)
        await self.redis_client.setex(redis_cache_info.key, redis_cache_info.timeout, value)

    async def get_with_cache_info(self, redis_cache_info: RedisCacheInfo):
        """
        根据 RedisCacheInfo 获取 Redis 缓存
        :param redis_cache_info: RedisCacheInfo 缓存信息对象
        :return:
        """
        cache_info = await self.redis_client.get(redis_cache_info.key)
        return cache_info

    async def del_with_cache_info(self, redis_cache_info: RedisCacheInfo):
        """
        根据 RedisCacheInfo 删除 Redis 缓存
        :param redis_cache_info: RedisCacheInfo缓存信息对象
        :return:
        """
        await self.redis_client.delete(redis_cache_info.key)
